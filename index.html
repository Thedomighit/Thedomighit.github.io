<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas de Reasignación</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- VARIABLES DE ESTILO --- */
        :root {
            --primary-color: #0077c2;
            --secondary-color: #555e6a;
            --background-light: #f4f6f9;
            --card-background: #ffffff;
            --border-color: #e0e0e0;
            --success-color: #1a995e;
            --danger-color: #d9534f;
            --excel-header-color: #e6f7ff;
            --excel-border-color: #c9c9c9;
            --complete-button-color: #ff9800;
            --history-color: #00bcd4;
            --font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            --toggle-color: #6c757d;
            --sticky-nav-color: #34495e; /* Color oscuro para la barra de navegación rápida */
        }

        /* --- ESTILOS GENERALES Y LAYOUT --- */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            background-color: var(--background-light);
            color: #333;
            line-height: 1.6;
            scroll-behavior: smooth; /* Desplazamiento suave para la navegación */
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 30px;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        /* Títulos */
        h1 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-weight: 300;
            font-size: 2.2em;
        }

        /* Secciones */
        .section {
            margin-bottom: 35px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: #ffffff;
            transition: box-shadow 0.3s;
        }
        
        .section:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }

        /* Encabezados de Sección con Toggle */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            color: var(--secondary-color);
            margin: 0;
            font-size: 1.6em;
            font-weight: 500;
        }
        
        .section-header button {
            background: none;
            border: 1px solid var(--toggle-color);
            color: var(--toggle-color);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .section-header button:hover {
            background-color: var(--toggle-color);
            color: white;
        }
        
        .section-content {
            padding-top: 10px;
            transition: max-height 0.5s ease-in-out, opacity 0.5s;
            overflow: hidden;
        }

        /* --- STICKY NAVIGATION --- */
        .sticky-nav {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 990;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .sticky-nav-button {
            background-color: var(--sticky-nav-color);
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: left;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, transform 0.1s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .sticky-nav-button:hover {
            background-color: #2c3e50;
            transform: scale(1.03);
        }
        
        .sticky-nav-button i {
            font-size: 1.1em;
        }


        /* --- ITEMS DE COPIA Y BOTONES --- */
        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 15px;
            flex-wrap: nowrap; 
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
        }

        .info-item strong {
            min-width: 150px; 
            flex-shrink: 0; 
            font-weight: 600;
            color: #333;
        }

        .copy-target, .editable-input {
            background-color: #f7f7f7;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #dcdcdc;
            flex-grow: 1; 
            min-width: 150px;
            font-family: 'Consolas', monospace;
            overflow-x: auto;
            white-space: nowrap;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        
        .editable-input {
            width: auto;
            color: var(--danger-color);
            font-weight: bold;
            border: 1px solid var(--danger-color);
        }

        .copy-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 18px;
            text-align: center;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, transform 0.1s;
            min-width: 100px;
            flex-shrink: 0; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* --- GENERADOR DE TABLA --- */
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #generateButton {
            background-color: var(--success-color);
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #showHistoryButton {
            background-color: var(--history-color);
        }
        
        /* --- ESTILOS DE TABLAS --- */
        .excel-table-container {
             margin-top: 20px;
             overflow-x: auto; 
             -webkit-overflow-scrolling: touch;
        }
        
        .excel-table {
            width: 100%;
            min-width: 900px; 
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .excel-table th, .excel-table td {
            border: 1px solid var(--excel-border-color);
            padding: 10px 8px;
            text-align: left;
            white-space: nowrap; 
        }

        .excel-table th {
            background-color: var(--excel-header-color);
            font-weight: 600;
        }
        
        .excel-table .cell-copy {
            cursor: copy;
            font-weight: bold;
            color: var(--primary-color);
            background-color: #e6f7ff; 
            transition: background-color 0.1s;
        }
        
        .history-table .cell-copy {
             background-color: #fff; /* Resetear fondo para el historial */
             color: #333;
             cursor: default;
        }
        
        /* Estilos específicos para las celdas de Comentario y Suministro en el historial */
        .history-table td.comment-cell {
            min-width: 300px;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .history-table td.suministro-cell {
            font-weight: bold;
            color: var(--danger-color);
        }
        
        /* Botones de acción dentro de las celdas del historial */
        .history-actions-cell {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .history-actions-cell button {
            padding: 6px 10px;
            font-size: 0.8em;
            white-space: nowrap;
        }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                box-shadow: none; 
            }
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                padding-bottom: 10px;
            }
            .info-item .copy-target, 
            .info-item .editable-input,
            .info-item .copy-button {
                width: 100%;
                min-width: 100%; 
            }
            
            /* Botones principales de la lista se apilan */
            .control-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            #generateButton, #showHistoryButton {
                width: 100%;
                margin: 0 !important;
            }
            
            /* Sticky Nav se mueve a la parte inferior en móvil */
            .sticky-nav {
                top: auto; 
                bottom: 10px; 
                right: 50%;
                transform: translateX(50%);
                flex-direction: row; /* Se pone horizontal */
                overflow-x: auto; /* Permite scroll si hay muchos botones */
                width: 95%;
                padding: 8px;
                gap: 5px;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            }
            
            .sticky-nav-button {
                padding: 8px 10px;
                font-size: 0.8em;
                flex-shrink: 0;
            }
            
            .sticky-nav-button span {
                 display: none; /* Ocultar el texto para ahorrar espacio */
            }
        }
    </style>
</head>
<body>
    
    <div class="sticky-nav">
        <a href="#tarea-activa-section" class="sticky-nav-button"><i class="fas fa-clipboard-list"></i> <span>Activa</span></a>
        <a href="#tareas-pendientes-section" class="sticky-nav-button"><i class="fas fa-list-alt"></i> <span>Pendientes</span></a>
        <a href="#historySection" class="sticky-nav-button"><i class="fas fa-archive"></i> <span>Historial</span></a>
        <a href="#accesos-credenciales-section" class="sticky-nav-button"><i class="fas fa-key"></i> <span>Accesos</span></a>
        <a href="#buscador-medicamentos-section" class="sticky-nav-button"><i class="fas fa-prescription-bottle-alt"></i> <span>Medicamentos</span></a>
    </div>

    <div class="container">
        <h1><i class="fas fa-tasks"></i> Gestor de Tareas de Reasignación</h1>

        <div id="saveNotification">
            <i class="fas fa-save"></i> Datos guardados automáticamente.
        </div>

        <div class="section">
             <div class="section-header">
                <h2><i class="fas fa-user-tag"></i> Designación de Tarea</h2>
            </div>
            <div class="section-content">
                <div class="info-item">
                    <strong>ACCIÓN:</strong>
                    <span id="accion" class="copy-target" style="color: var(--danger-color);">Reasignar</span>
                    <button class="copy-button" onclick="copiarTexto('accion')" style="background-color: var(--danger-color);"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                 <div class="info-item">
                    <strong>NOMBRE DE DESTINO:</strong>
                    <span id="reasignar" class="copy-target">BRAYAN CORONADO CUELLAR</span>
                    <button class="copy-button" onclick="copiarTexto('reasignar')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
            </div>
        </div>


        <div class="section" id="tarea-activa-section">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-list"></i> Tarea Activa (Datos Principales)</h2>
            </div>
             <div class="section-content">
                <p style="color: var(--secondary-color); font-size: 0.9em;">**NOTA IMPORTANTE:** El **Radicado / ID Actual** se actualiza automáticamente con el **Cód. Suministro** de la primera tarea pendiente.</p>
                
                <div class="info-item">
                    <strong>RADICADO / ID ACTUAL:</strong>
                    <input type="text" id="radicado" class="copy-target editable-input" value="">
                    <button class="copy-button" onclick="copiarTexto('radicado')"><i class="fas fa-copy"></i> Copiar Radicado</button>
                </div>
                <div class="info-item">
                    <strong>INICIO MOVILIDAD (MV):</strong>
                    <span id="mv" class="copy-target">Colombia2033*</span>
                    <button class="copy-button" onclick="copiarTexto('mv')"><i class="fas fa-copy"></i> Copiar Clave MV</button>
                </div>
                <div class="info-item">
                    <strong>CÓDIGO SUMINISTRO:</strong>
                    <span id="suministro" class="copy-target">91010101</span>
                    <button class="copy-button" onclick="copiarTexto('suministro')"><i class="fas fa-copy"></i> Copiar Código</button>
                </div>
             </div>
        </div>
        
        
        <div class="section" id="tareas-pendientes-section">
            <div class="section-header">
                <h2><i class="fas fa-list-alt"></i> Tareas Pendientes y Gestión</h2>
                <button onclick="toggleSection('tareas-pendientes-content', this)"><i class="fas fa-angle-up"></i> Ver Menos</button>
            </div>
            
            <div class="section-content" id="tareas-pendientes-content">
                <p style="color: var(--secondary-color);">**Instrucción:** Pega el listado de liquidaciones aquí y haz clic en Construir Lista.</p>
                
                <textarea id="dataInput" placeholder="Pega aquí los datos de Excel (cada liquidación en una línea nueva)...
Ejemplo:
Asignado Liquidacion 242385169 900190045 $ 28.700 $ 0 Nueva EPS 1
Por Vencer 251789321 811021843 $ 39.500 $ 0 Nueva EPS 1"></textarea>
                
                <div class="control-buttons">
                    <button id="generateButton" onclick="generarTablaPersonalizada()"><i class="fas fa-cogs"></i> Construir Lista de Tareas</button>
                    <button id="showHistoryButton" class="copy-button" onclick="mostrarHistorial()"><i class="fas fa-history"></i> Ver Historial</button>
                </div>

                <div id="dynamicTableOutput">
                    <p style="text-align: center; color: var(--secondary-color); padding: 10px; border: 1px dashed #ccc; border-radius: 5px;">*La lista de tareas pendientes aparecerá aquí.*</p>
                </div>
                
                <div id="copyAllIdsContainer" class="info-item" style="display:none; margin-top: 20px; border: none; padding-bottom: 0;">
                    <span id="generated-ids-copia-manual" class="copy-target" style="display: none;"></span>
                    <button id="copyAllIdsButton" class="copy-button" onclick="copiarTexto('generated-ids-copia-manual')" style="background-color: var(--success-color); flex-grow: 1;"><i class="fas fa-paste"></i> Copiar TODOS los IDs restantes</button>
                </div>
            </div>
        </div>

        
        <div class="section" id="historySection">
            <div class="section-header">
                <h2><i class="fas fa-archive"></i> Historial de Tareas Completadas</h2>
                <button onclick="toggleSection('historyOutput', this)"><i class="fas fa-angle-down"></i> Ver Más</button>
            </div>
            <div class="section-content" id="historyOutput" style="display:none;">
                <div class="history-actions">
                    <button id="deleteAllHistoryButton" onclick="eliminarHistorialCompleto()"><i class="fas fa-trash-alt"></i> Eliminar Historial Completo</button>
                    <p style="color: var(--secondary-color);">*El historial se guarda automáticamente en tu navegador.</p>
                </div>
                 <div id="historyTableContainer">
                    <p style="color: var(--secondary-color); text-align: center; padding: 10px; border: 1px dashed #ccc; border-radius: 5px;">No hay tareas archivadas.</p>
                 </div>
            </div>
        </div>
        

        <div class="section" id="accesos-credenciales-section">
            <div class="section-header">
                <h2><i class="fas fa-key"></i> Accesos y Credenciales</h2>
                <button onclick="toggleSection('accesos-credenciales-content', this)"><i class="fas fa-angle-down"></i> Ver Más</button>
            </div>
            
            <div class="section-content" id="accesos-credenciales-content" style="display:none;">
                
                <h3><i class="fas fa-user-lock"></i> ONBASE</h3>
                <div class="info-item">
                    <strong>URL:</strong>
                    <a id="onbaseURL" class="copy-target" href="https://ecm.nuevaeps.com.co/OnBase/Login.aspx" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">https://ecm.nuevaeps.com.co/OnBase/Login.aspx</a>
                    <button class="copy-button" onclick="copiarTexto('onbaseURL')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>USUARIO:</strong>
                    <span id="onbaseUser" class="copy-target">mgamas</span>
                    <button class="copy-button" onclick="copiarTexto('onbaseUser')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>CLAVE:</strong>
                    <span id="onbasePass" class="copy-target">Colombia2029*</span>
                    <button class="copy-button" onclick="copiarTexto('onbasePass')"><i class="fas fa-copy"></i> Copiar</button>
                </div>

                <br>
                
                <h3><i class="fas fa-desktop"></i> AUP</h3>
                <div class="info-item">
                    <strong>URL:</strong>
                    <a id="aupURL" class="copy-target" href="https://aup.procesosyservicios.net.co/Login.aspx" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">https://aup.procesosyservicios.net.co/Login.aspx</a>
                    <button class="copy-button" onclick="copiarTexto('aupURL')"><i class="fas fa-copy"></i> Copiar URL</button>
                </div>
                
                <br>

                <h3><i class="fas fa-hospital"></i> NUEVA EPS</h3>
                <div class="info-item">
                    <strong>USUARIO:</strong>
                    <span id="nuevaepsUser" class="copy-target">Bcoronadoccmp</span>
                    <button class="copy-button" onclick="copiarTexto('nuevaepsUser')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>CLAVE:</strong>
                    <span id="nuevaepsPass" class="copy-target">Pys2034*</span>
                    <button class="copy-button" onclick="copiarTexto('nuevaepsPass')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
            </div>
        </div>

        <div class="section search-container" id="buscador-medicamentos-section">
             <div class="section-header">
                <h2><i class="fas fa-prescription-bottle-alt"></i> Buscador de Códigos de Medicamentos</h2>
            </div>
            <div class="section-content">
                <p style="color: var(--secondary-color);">Escribe el nombre del medicamento para encontrar su código rápidamente. **Ahora se activa con solo 1 letra.**</p>
                <input type="text" id="searchInput" placeholder="Ej: AMLODIPINO, LOSARTAN..." onkeyup="buscarMedicamento()" class="copy-target">
                <div id="searchResult"></div>
            </div>
        </div>

    </div>

    <script>
        // --- VARIABLES GLOBALES Y ALMACENAMIENTO ---
        let listaDeTareas = [];
        let listaDeHistorial = [];

        // Colores y utilidades
        const var_success_color = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
        const var_primary_color = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
        const var_danger_color = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim();
        const var_toggle_color = getComputedStyle(document.documentElement).getPropertyValue('--toggle-color').trim();

        // ----------------------------------------------------
        // --- GESTIÓN DE LOCALSTORAGE (AUTO-GUARDADO) ---
        // ----------------------------------------------------

        function guardarDatos() {
            try {
                localStorage.setItem('reasignacion_tareas', JSON.stringify(listaDeTareas));
                localStorage.setItem('reasignacion_historial', JSON.stringify(listaDeHistorial));
                mostrarNotificacionGuardado();
            } catch (e) {
                console.error("Error al guardar en LocalStorage:", e);
            }
        }

        function cargarDatos() {
            try {
                const tareasGuardadas = localStorage.getItem('reasignacion_tareas');
                const historialGuardado = localStorage.getItem('reasignacion_historial');

                if (tareasGuardadas) {
                    listaDeTareas = JSON.parse(tareasGuardadas);
                    actualizarTextareaConLista();
                }
                if (historialGuardado) {
                    listaDeHistorial = JSON.parse(historialGuardado);
                    renderizarHistorial(); 
                }
            } catch (e) {
                console.error("Error al cargar datos de LocalStorage:", e);
            }
        }

        function mostrarNotificacionGuardado() {
            const notif = document.getElementById('saveNotification');
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 2000);
        }

        // ----------------------------------------------------
        // --- Funciones de Copia y Notificación ---
        // ----------------------------------------------------

        function copiarTexto(elementId) {
             const targetElement = document.getElementById(elementId);
             let textToCopy;
             if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA') {
                 textToCopy = targetElement.value;
             } else {
                 textToCopy = targetElement.textContent || targetElement.innerText;
             }
             copiarYNotificar(targetElement, textToCopy);
        }
        function copiarTextoTabla(cellElement) {
             const textToCopy = cellElement.textContent || cellElement.innerText;
             copiarYNotificar(cellElement, textToCopy, true);
        }
        
        // Función específica para copiar contenido del historial
        function copiarHistorialItem(index, type) {
            let textToCopy;
            let elementToNotify;
            
            const tarea = listaDeHistorial[index];
            
            if (type === 'suministro') {
                textToCopy = tarea.codSuministro;
                elementToNotify = document.getElementById(`suministro-copy-${index}`);
            } else if (type === 'comentario') {
                textToCopy = tarea.comentario;
                elementToNotify = document.getElementById(`comment-copy-${index}`);
            } else {
                return;
            }
            
            // Usamos la función de copia y notificación principal
            copiarYNotificar(elementToNotify, textToCopy, false); 
        }

        function copiarYNotificar(targetElement, textToCopy, isTableCell = false) {
             if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        mostrarNotificacion(targetElement, '✅ Copiado!', isTableCell);
                    })
                    .catch(err => {
                        copiarTextoFallback(targetElement, textToCopy, isTableCell);
                    });
            } else {
                copiarTextoFallback(targetElement, textToCopy, isTableCell);
            }
        }
        
        function copiarTextoFallback(targetElement, textToCopy, isTableCell) {
             const textArea = document.createElement("textarea");
             textArea.value = textToCopy;
             textArea.style.position = "fixed"; 
             textArea.style.opacity = "0"; 
             document.body.appendChild(textArea);
             textArea.focus();
             textArea.select();
             try {
                 document.execCommand('copy');
                 mostrarNotificacion(targetElement, '✅ Copiado!', isTableCell);
             } catch (err) {
                 alert('Error al copiar. Por favor, copie manualmente: ' + textToCopy);
             }
             document.body.removeChild(textArea);
        }

        function mostrarNotificacion(targetElement, message, isTableCell) {
            let button = targetElement;
            let originalText = button.textContent;
            let restoreColor = getComputedStyle(button).backgroundColor;
            
            // Si no es una celda de tabla (copiarTextoTabla), el elemento notificador es el botón siguiente
            if (!isTableCell) {
                // Si es un botón del sticky nav o historial, el target ya es el botón
                if (targetElement.classList.contains('copy-button') || targetElement.classList.contains('sticky-nav-button') || targetElement.id.startsWith('suministro-copy') || targetElement.id.startsWith('comment-copy')) {
                    // Mantener targetElement como button
                } else {
                    // Si viene de copiarTexto, el botón es el siguiente elemento
                    button = targetElement.nextElementSibling;
                    if (!button || !button.classList.contains('copy-button')) {
                        // Manejo de casos especiales (buscador, IDs masivos)
                        if (targetElement.id.startsWith('codigo-med-result')) {
                           button = targetElement.closest('.info-item').querySelector('.copy-button');
                        } else if (targetElement.id === 'generated-ids-copia-manual') {
                           button = document.getElementById('copyAllIdsButton');
                        } else {
                            return;
                        }
                    }
                    restoreColor = getComputedStyle(button).backgroundColor;
                }
            } else {
                 // Si es una celda de tabla (copiarTextoTabla), la notificación es temporal en la celda
                 originalText = button.textContent;
                 restoreColor = getComputedStyle(button).backgroundColor;
            }

            // Aplicar la notificación
            button.textContent = message;
            button.style.backgroundColor = var_success_color;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = restoreColor;
            }, 1500);
        }


        // ----------------------------------------------------
        // --- Generador de Tabla y Gestión de Tareas ---
        // ----------------------------------------------------

        function generarTablaPersonalizada() {
            const inputElement = document.getElementById('dataInput');
            const rawText = inputElement.value.trim();
            listaDeTareas = [];

            if (!rawText) {
                renderizarTabla();
                return;
            }

            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            lines.forEach(line => {
                // EXPRESION REGULAR: Separa por uno o más espacios en blanco.
                const cells = line.trim().split(/\s{1,}/);
                
                if (cells.length >= 8) {
                    listaDeTareas.push({
                        estatus: cells[0],
                        tipo: cells[1],
                        id: cells[2], // ID LIQUIDACIÓN (POSICIÓN 3)
                        codSuministro: cells[3], // CÓD. SUMINISTRO (POSICIÓN 4) <-- ¡ESTE ES EL QUE BUSCAMOS!
                        valor: cells[4],
                        ahorro: cells[5],
                        eps: cells[6],
                        num: cells[7]
                    });
                }
            });

            renderizarTabla();
            guardarDatos(); 
        }

        function renderizarTabla() {
            const outputDiv = document.getElementById('dynamicTableOutput');
            const radicadoInput = document.getElementById('radicado');
            const copyAllIdsContainer = document.getElementById('copyAllIdsContainer');
            const copyAllIdsSpan = document.getElementById('generated-ids-copia-manual');
            
            outputDiv.innerHTML = '';
            copyAllIdsContainer.style.display = 'none';
            radicadoInput.value = ''; // Limpiar radicado por defecto si no hay tareas

            if (listaDeTareas.length === 0) {
                outputDiv.innerHTML = '<p style="text-align: center; color: var(--secondary-color); padding: 10px; border: 1px dashed #ccc; border-radius: 5px;"><i class="fas fa-check-circle"></i> Todas las tareas han sido completadas o no hay datos cargados.</p>';
                return;
            }

            // **PUNTO CLAVE DE ACTUALIZACIÓN:** Toma el Cód. Suministro de la primera tarea
            if (listaDeTareas.length > 0) {
                radicadoInput.value = listaDeTareas[0].codSuministro; 
            }

            let tableHTML = `
                <div class="excel-table-container">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th>Estatus</th>
                                <th>Tipo</th>
                                <th>ID Liquidación</th>
                                <th>Cód. Suministro</th>
                                <th>Valor</th>
                                <th>Ahorro</th>
                                <th>EPS</th>
                                <th>Num</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let allIds = [];
            
            listaDeTareas.forEach((tarea, index) => {
                allIds.push(tarea.id); 
                
                tableHTML += `
                    <tr id="tarea-row-${index}">
                        <td>${tarea.estatus}</td>
                        <td>${tarea.tipo}</td>
                        <td class="cell-copy" onclick="copiarTextoTabla(this)">${tarea.id}</td>
                        <td class="cell-copy" onclick="copiarTextoTabla(this)">${tarea.codSuministro}</td>
                        <td>${tarea.valor}</td>
                        <td>${tarea.ahorro}</td>
                        <td>${tarea.eps}</td>
                        <td>${tarea.num}</td>
                        <td style="text-align: center;">
                            <button class="complete-row-button" onclick="mostrarComentario(${index})"><i class="fas fa-archive"></i> Archivar</button>
                            <div id="comment-box-${index}" class="comment-container">
                                <span class="comment-counter">Tareas: 1</span>
                                <textarea id="comment-text-${index}" placeholder="Escribe tu comentario..."></textarea>
                                <button class="save-comment-button" onclick="marcarCompletado(${index})"><i class="fas fa-save"></i> Guardar Comentario</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            outputDiv.innerHTML = tableHTML;
            
            copyAllIdsSpan.textContent = allIds.join(', ');
            copyAllIdsContainer.style.display = 'flex';
        }

        function mostrarComentario(index) {
            const commentBox = document.getElementById(`comment-box-${index}`);
            document.querySelectorAll('.comment-container').forEach(box => {
                if (box.id !== `comment-box-${index}`) {
                    box.style.display = 'none';
                }
            });
            commentBox.style.display = commentBox.style.display === 'block' ? 'none' : 'block';
        }

        // ----------------------------------------------------
        // --- FUNCIÓN CRÍTICA DE ARCHIVADO ---
        // ----------------------------------------------------

        function marcarCompletado(index) {
            
            if (index !== 0) {
                 alert("¡Atención! Solo se puede archivar la primera tarea de la lista.");
                 return;
            }

            const tareaCompletada = listaDeTareas[index];

            if (!tareaCompletada) {
                alert("Error crítico: No se encontró la tarea en el índice especificado. Intente recargar.");
                return;
            }
            
            try {
                const commentTextElement = document.getElementById(`comment-text-${index}`);
                const commentText = commentTextElement ? commentTextElement.value.trim() : 'Sin comentario';
                
                // Mover la tarea al historial (Guardado)
                tareaCompletada.comentario = commentText;
                tareaCompletada.fecha = new Date().toLocaleString();
                listaDeHistorial.push(tareaCompletada);
                
                // Eliminación visual INMEDIATA para feedback
                const rowToRemove = document.getElementById(`tarea-row-${index}`);
                if (rowToRemove) {
                    rowToRemove.style.transition = 'all 0.4s ease-in-out';
                    rowToRemove.style.opacity = '0';
                }

                // Eliminar la tarea de la lista pendiente (index 0)
                listaDeTareas.splice(0, 1); 
                
                // Actualizar el textarea con la lista restante
                actualizarTextareaConLista();
                
                setTimeout(() => {
                    // Volver a dibujar la tabla, moviendo la segunda a la primera posición
                    renderizarTabla(); 
                    // Renderizar el historial para mostrar la tarea archivada
                    renderizarHistorial(); 
                    // Guardar en LocalStorage
                    guardarDatos(); 

                    alert(`Tarea ${tareaCompletada.id} archivada con éxito.
                    La siguiente tarea (${listaDeTareas.length > 0 ? listaDeTareas[0].codSuministro : 'N/A'}) se ha cargado automáticamente en el Radicado.
                    Total en historial: ${listaDeHistorial.length}`);
                }, 400); // 400ms para la animación

            } catch (e) {
                alert("¡ERROR CRÍTICO! Fallo durante el proceso de archivado. Mensaje de Error: " + e.message);
                console.error("Fallo durante el proceso de archivado:", e);
            }
        }
        // ----------------------------------------------------


        function actualizarTextareaConLista() {
            const inputElement = document.getElementById('dataInput');
            let newText = '';
            
            listaDeTareas.forEach(tarea => {
                newText += `${tarea.estatus} ${tarea.tipo} ${tarea.id} ${tarea.codSuministro} ${tarea.valor} ${tarea.ahorro} ${tarea.eps} ${tarea.num}\n`;
            });
            
            inputElement.value = newText.trim();
        }
        
        // ----------------------------------------------------
        // --- Gestión de Historial (Archivado) ---
        // ----------------------------------------------------
        
        function renderizarHistorial() {
            const historyOutput = document.getElementById('historyTableContainer');
            
            if (listaDeHistorial.length === 0) {
                 historyOutput.innerHTML = '<p style="color: var(--secondary-color); text-align: center; padding: 10px; border: 1px dashed #ccc; border-radius: 5px;"><i class="fas fa-info-circle"></i> El historial está vacío.</p>';
                 return;
            }

            let tableHTML = `
                <div class="excel-table-container">
                    <table class="excel-table history-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-alt"></i> Fecha/Hora</th>
                                <th>ID Liquidación</th>
                                <th>Cód. Suministro</th>
                                <th>EPS</th>
                                <th>Valor</th>
                                <th style="min-width: 350px;"><i class="fas fa-comment"></i> Comentario</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Mostrar del más reciente al más antiguo
            listaDeHistorial.slice().reverse().forEach((tarea, indexReversed) => { 
                const originalIndex = listaDeHistorial.length - 1 - indexReversed;

                tableHTML += `
                    <tr>
                        <td>${tarea.fecha}</td>
                        <td class="cell-copy">${tarea.id}</td>
                        <td id="suministro-display-${originalIndex}" class="suministro-cell">${tarea.codSuministro}</td>
                        <td>${tarea.eps}</td>
                        <td>${tarea.valor}</td>
                        <td id="comment-display-${originalIndex}" class="comment-cell">${tarea.comentario}</td>
                        <td class="history-actions-cell">
                            <button id="suministro-copy-${originalIndex}" class="copy-button" onclick="copiarHistorialItem(${originalIndex}, 'suministro')"><i class="fas fa-copy"></i> C.Sumin.</button>
                            <button id="comment-copy-${originalIndex}" class="copy-button" onclick="copiarHistorialItem(${originalIndex}, 'comentario')" style="background-color: var(--secondary-color);"><i class="fas fa-copy"></i> C.Coment.</button>
                            <button class="edit-comment-button" onclick="iniciarEdicionComentario(${originalIndex}, this)"><i class="fas fa-edit"></i> Editar</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            historyOutput.innerHTML = tableHTML;
        }

        function mostrarHistorial() {
            const content = document.getElementById('historyOutput');
            const headerButton = document.getElementById('historySection').querySelector('.section-header button');

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                headerButton.innerHTML = '<i class="fas fa-angle-up"></i> Ver Menos';
                renderizarHistorial(); 
            } else {
                content.style.display = 'none';
                headerButton.innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            }
        }


        function eliminarHistorialCompleto() {
            if (confirm("¿Estás seguro de que quieres ELIMINAR TODO el historial de tareas completadas? Esta acción es irreversible.")) {
                listaDeHistorial = [];
                renderizarHistorial();
                guardarDatos();
                alert("Historial eliminado con éxito.");
            }
        }
        
        function iniciarEdicionComentario(index, buttonElement) {
            const commentCell = document.getElementById(`comment-display-${index}`);
            const tarea = listaDeHistorial[index];
            const originalComment = tarea.comentario;
            
            commentCell.innerHTML = `
                <textarea id="edit-text-${index}" style="width: 100%; height: 60px; margin-bottom: 5px; box-sizing: border-box;">${originalComment}</textarea>
                <div style="display: flex; gap: 5px;">
                    <button class="save-comment-button" onclick="guardarComentarioEditado(${index})"><i class="fas fa-save"></i> Guardar</button>
                    <button class="copy-button" style="background-color: #f0ad4e; margin-left: 0;" onclick="cancelarEdicionComentario(${index}, \`${originalComment.replace(/`/g, '\\`')}\`)"><i class="fas fa-times"></i> Cancelar</button>
                </div>
            `;
            
            // Deshabilitar o cambiar estilo de los botones de la misma fila
            const rowButtons = buttonElement.closest('td').querySelectorAll('button');
            rowButtons.forEach(btn => {
                 if (btn !== buttonElement) {
                    btn.disabled = true;
                    btn.style.opacity = 0.5;
                }
            });

            buttonElement.style.display = 'none';
        }

        function guardarComentarioEditado(index) {
            const newComment = document.getElementById(`edit-text-${index}`).value.trim();
            
            listaDeHistorial[index].comentario = newComment;
            
            renderizarHistorial();
            guardarDatos();
        }

        function cancelarEdicionComentario(index, originalComment) {
            const commentCell = document.getElementById(`comment-display-${index}`);
            commentCell.innerHTML = originalComment;
            
            const editButton = commentCell.closest('tr').querySelector('.edit-comment-button');
             // Habilitar de nuevo todos los botones de la fila
            const rowButtons = editButton.closest('td').querySelectorAll('button');
            rowButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = 1;
            });
            editButton.style.display = 'inline-block';
            
            renderizarHistorial(); // Para asegurar que los botones de copia se restablezcan
        }
        
        // ----------------------------------------------------
        // --- Utilidades de Interfaz ---
        // ----------------------------------------------------

        function toggleSection(contentId, buttonElement) {
            const content = document.getElementById(contentId);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                buttonElement.innerHTML = '<i class="fas fa-angle-up"></i> Ver Menos';
            } else {
                content.style.display = 'none';
                buttonElement.innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            }
        }


        // --- Base de Datos de Medicamentos y Buscador ---
        const medicamentos = { 
            "AMLODIPINO TABLETAS 5MG": "MD000150",
            "ACIDO ACETILSALICILICO 100 MG": "MD004978",
            "LOSARTAN TABLETA 50MG": "MD000161",
            "HIDROCLOROTIAZIDA TABLETA 25 MG": "MD000134",
            "METOPROLOL TABLETA 50 MG": "MD000145",
            "ATORVASTATINA TABLETA 40MG": "MD001258",
            "PRAZOSIN TABLETA 1 MG": "MD000132",
            "METFORMINA TABLETA 850 MG": "MD000032",
            "NAPROXENO TABLETA 250 MG": "MD000402",
            "PROPRANOLOL TABLETA 40 MG": "MD000148",
            "IBUPROFENO TABLETA 400 MG": "MD000300",
            "OMEPRAZOL CAPSULA 20 MG": "MD000200",
            "CLOPIDOGREL TABLETA 75 MG": "MD000555",
            "SIMVASTATINA TABLETA 20 MG": "MD000188"
        };
        
        function buscarMedicamento() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase().trim();
            const resultDiv = document.getElementById('searchResult');
            resultDiv.innerHTML = ''; 
            
            if (filter.length < 1) { 
                resultDiv.innerHTML = '<span style="color: var(--secondary-color);">Escriba al menos 1 letra para iniciar la búsqueda.</span>';
                return;
            }

            let found = false;
            let resultsHTML = '';
            
            for (const nombre in medicamentos) {
                if (nombre.toUpperCase().includes(filter)) {
                    const codigo = medicamentos[nombre];
                    const codigoId = `codigo-med-result-${codigo}`; 
                    
                    resultsHTML += `
                        <div class="info-item" style="border-bottom: none;">
                            <strong style="color: #000; min-width: auto; flex-basis: 50%;">${nombre}</strong>
                            <span id="${codigoId}" class="copy-target" style="flex-grow: 0; background-color: #ffe0e0;">${codigo}</span>
                            <button class="copy-button" onclick="copiarTexto('${codigoId}')" style="background-color: var(--danger-color);"><i class="fas fa-copy"></i> Copiar Código</button>
                        </div>
                    `;
                    found = true;
                }
            }

            if (found) {
                 resultDiv.innerHTML = resultsHTML;
            } else {
                resultDiv.innerHTML = '<span style="color: var(--secondary-color);">❌ No se encontró el medicamento.</span>';
            }
        }

        // --- Inicialización al cargar la página ---
        window.onload = function() {
            cargarDatos();
            
            if (listaDeTareas.length === 0) {
                 document.getElementById('radicado').value = '';
            } else {
                 renderizarTabla();
            }

            // Asegurar que las secciones estén en su estado inicial (colapsado)
            document.getElementById('historyOutput').style.display = 'none';
            document.getElementById('accesos-credenciales-content').style.display = 'none';
            
            // Establecer el texto de los botones de Ver Más/Menos
            document.getElementById('historySection').querySelector('.section-header button').innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            document.getElementById('accesos-credenciales-section').querySelector('.section-header button').innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
        };
    </script>
</body>
</html>
