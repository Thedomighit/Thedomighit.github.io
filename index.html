<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas de Reasignación</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- VARIABLES DE ESTILO --- */
        :root {
            --primary-color: #0077c2;
            --secondary-color: #555e6a;
            --background-light: #f4f6f9;
            --card-background: #ffffff;
            --border-color: #e0e0e0;
            --success-color: #1a995e;
            --danger-color: #d9534f;
            --excel-header-color: #e6f7ff;
            --excel-border-color: #c9c9c9;
            --complete-button-color: #ff9800;
            --history-color: #00bcd4;
            --font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            --toggle-color: #6c757d;
        }

        /* --- ESTILOS GENERALES Y LAYOUT --- */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            background-color: var(--background-light);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 30px;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        /* Títulos */
        h1 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-weight: 300;
            font-size: 2.2em;
        }

        /* Secciones */
        .section {
            margin-bottom: 35px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: #ffffff;
            transition: box-shadow 0.3s;
        }
        
        .section:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }

        /* Encabezados de Sección con Toggle */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            color: var(--secondary-color);
            margin: 0;
            font-size: 1.6em;
            font-weight: 500;
        }
        
        .section-header button {
            background: none;
            border: 1px solid var(--toggle-color);
            color: var(--toggle-color);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .section-header button:hover {
            background-color: var(--toggle-color);
            color: white;
        }
        
        .section-content {
            padding-top: 10px;
            transition: max-height 0.5s ease-in-out, opacity 0.5s;
            overflow: hidden;
        }

        /* --- ITEMS DE COPIA Y BOTONES --- */
        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 15px;
            flex-wrap: wrap;
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
        }

        .info-item strong {
            min-width: 150px; 
            font-weight: 600;
            color: #333;
        }

        .copy-target {
            background-color: #f7f7f7;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #dcdcdc;
            flex-grow: 1;
            min-width: 150px;
            font-family: 'Consolas', monospace;
            overflow-x: auto;
            white-space: nowrap;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        
        .copy-target:focus {
            background-color: #fff;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .editable-input {
            width: auto;
            color: var(--danger-color);
            font-weight: bold;
            border: 1px solid var(--danger-color);
        }

        .copy-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 18px;
            text-align: center;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, transform 0.1s;
            min-width: 100px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .copy-button:hover {
            background-color: #005f9c;
            transform: translateY(-1px);
        }

        /* --- GENERADOR DE TABLA --- */
        #dataInput {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: 'Consolas', monospace;
            resize: vertical;
            background-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        #generateButton, #copyAllIdsButton, #showHistoryButton {
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        #generateButton {
            background-color: var(--success-color);
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #generateButton:hover {
            background-color: #15734e;
        }

        /* Botones de Historial */
        #showHistoryButton {
            background-color: var(--history-color);
            margin-left: 10px;
        }
        
        #showHistoryButton:hover {
             background-color: #0097a7;
        }

        /* --- ESTILOS DE TABLAS (Responsive) --- */
        .excel-table-container {
             margin-top: 20px;
             /* Permite el scroll horizontal en pantallas pequeñas */
             overflow-x: auto; 
             -webkit-overflow-scrolling: touch;
        }
        
        .excel-table {
            width: 100%;
            min-width: 900px; /* Asegura que la tabla no se colapse demasiado */
            border-collapse: collapse;
            font-size: 0.85em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .excel-table th, .excel-table td {
            border: 1px solid var(--excel-border-color);
            padding: 10px 8px;
            text-align: left;
            white-space: nowrap; /* Evita que el texto de las celdas se rompa */
        }

        .excel-table th {
            background-color: var(--excel-header-color);
            font-weight: 600;
            color: var(--secondary-color);
            text-transform: uppercase;
            position: sticky; 
            top: 0; /* Sticky header para mejor UX */
        }
        
        .excel-table tr:nth-child(even) {
            background-color: #fcfcfc;
        }

        .excel-table .cell-copy {
            cursor: copy;
            font-weight: bold;
            color: var(--primary-color);
            background-color: #e6f7ff; 
            transition: background-color 0.1s;
        }
        
        .excel-table .cell-copy:hover {
            background-color: #cceeff;
        }
        
        /* Gestión de Comentarios */
        .complete-row-button {
            background-color: var(--complete-button-color);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .comment-container {
            padding: 12px;
            margin-top: 10px;
            border: 1px solid var(--complete-button-color);
            border-radius: 5px;
            background-color: #fff8e1;
            display: none;
            position: relative;
        }
        
        .comment-counter {
            position: absolute;
            top: -10px; /* Posicionado fuera */
            right: 10px;
            background-color: var(--danger-color);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .comment-container textarea {
            width: 100%;
            height: 60px;
            padding: 8px;
            margin-top: 5px;
            resize: vertical;
            border: 1px solid #f9d8a3;
            border-radius: 3px;
        }

        .save-comment-button {
            background-color: var(--success-color);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        /* Historial Styling */
        .history-table td:last-child {
             max-width: 300px;
             word-wrap: break-word;
             font-size: 0.8em;
             background-color: #e6f7ff;
             color: #333;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #deleteAllHistoryButton {
            background-color: var(--danger-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        #deleteAllHistoryButton:hover {
             background-color: #b33936;
        }
        
        .edit-comment-button {
            background-color: var(--history-color);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s;
        }
        
        /* --- NOTIFICACIÓN DE AUTO-GUARDADO --- */
        #saveNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
            font-size: 0.9em;
        }
        
        #saveNotification.show {
            opacity: 1;
        }
        
        /* Estilo para el resultado de la búsqueda de medicamentos */
        .search-container .info-item {
            border: none;
            padding-bottom: 0;
            margin-top: 15px;
            background-color: #f0f8ff; /* Fondo suave para destacar */
            padding: 10px;
            border-radius: 6px;
        }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                box-shadow: none;
            }
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            .section-header h2 {
                font-size: 1.3em;
            }
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .info-item strong {
                min-width: 100%;
                margin-bottom: 0;
            }
            .info-item .copy-target, .info-item .copy-button {
                flex-grow: 1;
                width: 100%;
            }
            #generateButton, #showHistoryButton {
                width: 100%;
                margin-left: 0 !important;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1><i class="fas fa-tasks"></i> Gestor de Tareas de Reasignación</h1>

        <div id="saveNotification">
            <i class="fas fa-save"></i> Datos guardados automáticamente.
        </div>

        <div class="section">
             <div class="section-header">
                <h2><i class="fas fa-user-tag"></i> Designación de Tarea</h2>
            </div>
            <div class="section-content">
                <div class="info-item">
                    <strong>ACCIÓN:</strong>
                    <span id="accion" class="copy-target" style="color: var(--danger-color);">Reasignar</span>
                    <button class="copy-button" onclick="copiarTexto('accion')" style="background-color: var(--danger-color);"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                 <div class="info-item">
                    <strong>NOMBRE DE DESTINO:</strong>
                    <span id="reasignar" class="copy-target">BRAYAN CORONADO CUELLAR</span>
                    <button class="copy-button" onclick="copiarTexto('reasignar')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
            </div>
        </div>


        <div class="section">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-list"></i> Tarea Activa (Datos Principales)</h2>
            </div>
             <div class="section-content">
                <p style="color: var(--secondary-color); font-size: 0.9em;">**NOTA IMPORTANTE:** El **Radicado** se actualiza automáticamente con el ID de la **primera tarea pendiente**.</p>
                
                <div class="info-item">
                    <strong>RADICADO / ID ACTUAL:</strong>
                    <input type="text" id="radicado" class="copy-target editable-input" value="">
                    <button class="copy-button" onclick="copiarTexto('radicado')"><i class="fas fa-copy"></i> Copiar Radicado</button>
                </div>
                <div class="info-item">
                    <strong>INICIO MOVILIDAD (MV):</strong>
                    <span id="mv" class="copy-target">Colombia2033*</span>
                    <button class="copy-button" onclick="copiarTexto('mv')"><i class="fas fa-copy"></i> Copiar Clave MV</button>
                </div>
                <div class="info-item">
                    <strong>CÓDIGO SUMINISTRO:</strong>
                    <span id="suministro" class="copy-target">91010101</span>
                    <button class="copy-button" onclick="copiarTexto('suministro')"><i class="fas fa-copy"></i> Copiar Código</button>
                </div>
             </div>
        </div>
        
        
        <div class="section" id="tareas-pendientes-section">
            <div class="section-header">
                <h2><i class="fas fa-list-alt"></i> Tareas Pendientes y Gestión</h2>
                <button onclick="toggleSection('tareas-pendientes-content', this)"><i class="fas fa-angle-up"></i> Ver Menos</button>
            </div>
            
            <div class="section-content" id="tareas-pendientes-content">
                <p style="color: var(--secondary-color);">**Instrucción:** Pega el listado de liquidaciones aquí y haz clic en Construir Lista.</p>
                
                <textarea id="dataInput" placeholder="Pega aquí los datos de Excel (cada liquidación en una línea nueva)...
Ejemplo:
Asignado Liquidacion 242385169 900190045 $ 28.700 $ 0 Nueva EPS 1
Asignado Liquidacion 242385633 900190045 $ 28.700 $ 0 Nueva EPS 1"></textarea>
                
                <button id="generateButton" onclick="generarTablaPersonalizada()"><i class="fas fa-cogs"></i> Construir Lista de Tareas</button>
                <button id="showHistoryButton" class="copy-button" onclick="mostrarHistorial()"><i class="fas fa-history"></i> Ver Historial</button>

                <div id="dynamicTableOutput">
                    <p style="text-align: center; color: var(--secondary-color); padding: 10px; border: 1px dashed #ccc; border-radius: 5px;">*La lista de tareas pendientes aparecerá aquí.*</p>
                </div>
                
                <div id="copyAllIdsContainer" class="info-item" style="display:none; margin-top: 20px; border: none; padding-bottom: 0;">
                    <span id="generated-ids-copia-manual" class="copy-target" style="display: none;"></span>
                    <button id="copyAllIdsButton" class="copy-button" onclick="copiarTexto('generated-ids-copia-manual')" style="background-color: var(--success-color); flex-grow: 1;"><i class="fas fa-paste"></i> Copiar TODOS los IDs restantes</button>
                </div>
            </div>
        </div>

        
        <div class="section" id="historySection">
            <div class="section-header">
                <h2><i class="fas fa-archive"></i> Historial de Tareas Completadas</h2>
                <button onclick="toggleSection('historyOutput', this)"><i class="fas fa-angle-down"></i> Ver Más</button>
            </div>
            <div class="section-content" id="historyOutput" style="display:none;">
                <div class="history-actions">
                    <button id="deleteAllHistoryButton" onclick="eliminarHistorialCompleto()"><i class="fas fa-trash-alt"></i> Eliminar Historial Completo</button>
                    <p style="color: var(--secondary-color);">*El historial se carga automáticamente al iniciar la web si hay datos guardados.</p>
                </div>
                 <div id="historyTableContainer">
                    <p style="color: var(--secondary-color); text-align: center; padding: 10px; border: 1px dashed #ccc; border-radius: 5px;">No hay tareas archivadas. Utilice el botón "Ver Historial" en la sección superior.</p>
                 </div>
            </div>
        </div>
        

        <div class="section" id="accesos-credenciales-section">
            <div class="section-header">
                <h2><i class="fas fa-key"></i> Accesos y Credenciales</h2>
                <button onclick="toggleSection('accesos-credenciales-content', this)"><i class="fas fa-angle-down"></i> Ver Más</button>
            </div>
            
            <div class="section-content" id="accesos-credenciales-content" style="display:none;">
                
                <h3><i class="fas fa-user-lock"></i> ONBASE</h3>
                <div class="info-item">
                    <strong>URL:</strong>
                    <a id="onbaseURL" class="copy-target" href="https://ecm.nuevaeps.com.co/OnBase/Login.aspx" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">https://ecm.nuevaeps.com.co/OnBase/Login.aspx</a>
                    <button class="copy-button" onclick="copiarTexto('onbaseURL')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>USUARIO:</strong>
                    <span id="onbaseUser" class="copy-target">mgamas</span>
                    <button class="copy-button" onclick="copiarTexto('onbaseUser')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>CLAVE:</strong>
                    <span id="onbasePass" class="copy-target">Colombia2029*</span>
                    <button class="copy-button" onclick="copiarTexto('onbasePass')"><i class="fas fa-copy"></i> Copiar</button>
                </div>

                <br>
                
                <h3><i class="fas fa-desktop"></i> AUP</h3>
                <div class="info-item">
                    <strong>URL:</strong>
                    <a id="aupURL" class="copy-target" href="https://aup.procesosyservicios.net.co/Login.aspx" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">https://aup.procesosyservicios.net.co/Login.aspx</a>
                    <button class="copy-button" onclick="copiarTexto('aupURL')"><i class="fas fa-copy"></i> Copiar URL</button>
                </div>
                
                <br>

                <h3><i class="fas fa-hospital"></i> NUEVA EPS</h3>
                <div class="info-item">
                    <strong>USUARIO:</strong>
                    <span id="nuevaepsUser" class="copy-target">Bcoronadoccmp</span>
                    <button class="copy-button" onclick="copiarTexto('nuevaepsUser')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>CLAVE:</strong>
                    <span id="nuevaepsPass" class="copy-target">Pys2034*</span>
                    <button class="copy-button" onclick="copiarTexto('nuevaepsPass')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
            </div>
        </div>

        <div class="section search-container">
             <div class="section-header">
                <h2><i class="fas fa-prescription-bottle-alt"></i> Buscador de Códigos de Medicamentos</h2>
            </div>
            <div class="section-content">
                <p style="color: var(--secondary-color);">Escribe el nombre del medicamento para encontrar su código rápidamente. **Ahora se activa con solo 1 letra.**</p>
                <input type="text" id="searchInput" placeholder="Ej: AMOXICILINA, LISINOPRIL..." onkeyup="buscarMedicamento()" class="copy-target">
                <div id="searchResult"></div>
            </div>
        </div>

    </div>

    <script>
        // --- VARIABLES GLOBALES Y ALMACENAMIENTO ---
        let listaDeTareas = [];
        let listaDeHistorial = [];

        // Colores y utilidades
        const var_success_color = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
        const var_primary_color = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
        const var_danger_color = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim();
        const var_toggle_color = getComputedStyle(document.documentElement).getPropertyValue('--toggle-color').trim();

        // ----------------------------------------------------
        // --- GESTIÓN DE LOCALSTORAGE (AUTO-GUARDADO) ---
        // ----------------------------------------------------

        function guardarDatos() {
            try {
                localStorage.setItem('reasignacion_tareas', JSON.stringify(listaDeTareas));
                localStorage.setItem('reasignacion_historial', JSON.stringify(listaDeHistorial));
                mostrarNotificacionGuardado();
            } catch (e) {
                console.error("Error al guardar en LocalStorage:", e);
            }
        }

        function cargarDatos() {
            try {
                const tareasGuardadas = localStorage.getItem('reasignacion_tareas');
                const historialGuardado = localStorage.getItem('reasignacion_historial');

                if (tareasGuardadas) {
                    listaDeTareas = JSON.parse(tareasGuardadas);
                    actualizarTextareaConLista();
                    renderizarTabla();
                }
                if (historialGuardado) {
                    listaDeHistorial = JSON.parse(historialGuardado);
                    renderizarHistorial(false); 
                }
            } catch (e) {
                console.error("Error al cargar datos de LocalStorage:", e);
            }
        }

        function mostrarNotificacionGuardado() {
            const notif = document.getElementById('saveNotification');
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 2000);
        }

        // ----------------------------------------------------
        // --- Funciones de Copia y Notificación ---
        // ----------------------------------------------------

        function copiarTexto(elementId) {
             const targetElement = document.getElementById(elementId);
             let textToCopy;
             if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA') {
                 textToCopy = targetElement.value;
             } else {
                 textToCopy = targetElement.textContent || targetElement.innerText;
             }
             copiarYNotificar(targetElement, textToCopy);
        }
        function copiarTextoTabla(cellElement) {
             const textToCopy = cellElement.textContent || cellElement.innerText;
             copiarYNotificar(cellElement, textToCopy, true);
        }

        function copiarYNotificar(targetElement, textToCopy, isTableCell = false) {
             if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        mostrarNotificacion(targetElement, '✅ Copiado!', isTableCell);
                    })
                    .catch(err => {
                        copiarTextoFallback(targetElement, textToCopy, isTableCell);
                    });
            } else {
                copiarTextoFallback(targetElement, textToCopy, isTableCell);
            }
        }
        
        function copiarTextoFallback(targetElement, textToCopy, isTableCell) {
             const textArea = document.createElement("textarea");
             textArea.value = textToCopy;
             textArea.style.position = "fixed"; 
             textArea.style.opacity = "0"; 
             document.body.appendChild(textArea);
             textArea.focus();
             textArea.select();
             try {
                 document.execCommand('copy');
                 mostrarNotificacion(targetElement, '✅ Copiado!', isTableCell);
             } catch (err) {
                 alert('Error al copiar. Por favor, copie manualmente: ' + textToCopy);
             }
             document.body.removeChild(textArea);
        }

        function mostrarNotificacion(targetElement, message, isTableCell) {
            let button;
            let originalText;

            if (isTableCell) {
                button = targetElement;
                originalText = button.textContent;
                originalBg = getComputedStyle(button).backgroundColor;
                
                button.textContent = message;
                button.style.backgroundColor = var_success_color;

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = originalBg; 
                }, 1500);
            } else {
                button = targetElement.nextElementSibling;
                if (!button || !button.classList.contains('copy-button')) {
                    if (targetElement.id.startsWith('codigo-med-result')) {
                       // Si es el resultado del medicamento, el botón es el siguiente hermano.
                       button = targetElement.closest('.info-item').querySelector('.copy-button');
                    } else if (targetElement.id === 'generated-ids-copia-manual') {
                       button = document.getElementById('copyAllIdsButton');
                    } else {
                        return;
                    }
                }
                
                originalText = button.textContent;
                
                let restoreColor = var_primary_color;
                if (targetElement.id === 'accion') {
                    restoreColor = var_danger_color;
                } else if (targetElement.id === 'generated-ids-copia-manual') {
                    restoreColor = var_success_color;
                } else if (targetElement.id.startsWith('codigo-med-result')) {
                    restoreColor = var_danger_color;
                } else if (targetElement.id === 'radicado') {
                     restoreColor = var_primary_color; // Color base para el botón de radicado
                }

                button.textContent = message;
                button.style.backgroundColor = var_success_color;
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = restoreColor;
                }, 1500);
            }
        }

        // ----------------------------------------------------
        // --- Generador de Tabla y Gestión de Tareas ---
        // ----------------------------------------------------

        function generarTablaPersonalizada() {
            const inputElement = document.getElementById('dataInput');
            const rawText = inputElement.value.trim();
            listaDeTareas = [];

            if (!rawText) {
                renderizarTabla();
                return;
            }

            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            lines.forEach(line => {
                const cells = line.trim().split(/\s{1,}/);
                
                if (cells.length >= 8) {
                    listaDeTareas.push({
                        estatus: cells[0],
                        tipo: cells[1],
                        id: cells[2],
                        codSuministro: cells[3],
                        valor: cells[4],
                        ahorro: cells[5],
                        eps: cells[6],
                        num: cells[7]
                    });
                }
            });

            renderizarTabla();
            guardarDatos(); 
        }

        function renderizarTabla() {
            const outputDiv = document.getElementById('dynamicTableOutput');
            const radicadoInput = document.getElementById('radicado');
            const copyAllIdsContainer = document.getElementById('copyAllIdsContainer');
            const copyAllIdsSpan = document.getElementById('generated-ids-copia-manual');
            
            outputDiv.innerHTML = '';
            copyAllIdsContainer.style.display = 'none';
            radicadoInput.value = ''; // Limpiar radicado por defecto

            if (listaDeTareas.length === 0) {
                outputDiv.innerHTML = '<p style="text-align: center; color: var(--secondary-color); padding: 10px; border: 1px dashed #ccc; border-radius: 5px;"><i class="fas fa-check-circle"></i> Todas las tareas han sido completadas o no hay datos cargados.</p>';
                return;
            }

            // **ACTUALIZACIÓN DE RADICADO:** Toma el ID de la primera tarea
            if (listaDeTareas.length > 0) {
                radicadoInput.value = listaDeTareas[0].id; 
            }

            let tableHTML = `
                <div class="excel-table-container">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th>Estatus</th>
                                <th>Tipo</th>
                                <th>ID Liquidación</th>
                                <th>Cód. Suministro</th>
                                <th>Valor</th>
                                <th>Ahorro</th>
                                <th>EPS</th>
                                <th>Num</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let allIds = [];
            const tareasRestantes = listaDeTareas.length;
            
            listaDeTareas.forEach((tarea, index) => {
                allIds.push(tarea.id);
                
                tableHTML += `
                    <tr id="tarea-row-${index}">
                        <td>${tarea.estatus}</td>
                        <td>${tarea.tipo}</td>
                        <td class="cell-copy" onclick="copiarTextoTabla(this)">${tarea.id}</td>
                        <td>${tarea.codSuministro}</td>
                        <td>${tarea.valor}</td>
                        <td>${tarea.ahorro}</td>
                        <td>${tarea.eps}</td>
                        <td>${tarea.num}</td>
                        <td style="text-align: center;">
                            <button class="complete-row-button" onclick="mostrarComentario(${index})"><i class="fas fa-archive"></i> Archivar</button>
                            <div id="comment-box-${index}" class="comment-container">
                                <span class="comment-counter">Tareas: 1</span>
                                <textarea id="comment-text-${index}" placeholder="Escribe tu comentario..."></textarea>
                                <button class="save-comment-button" onclick="marcarCompletado(${index})"><i class="fas fa-save"></i> Guardar Comentario</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            outputDiv.innerHTML = tableHTML;
            
            copyAllIdsSpan.textContent = allIds.join(', ');
            copyAllIdsContainer.style.display = 'flex';
        }

        function mostrarComentario(index) {
            const commentBox = document.getElementById(`comment-box-${index}`);
            document.querySelectorAll('.comment-container').forEach(box => {
                if (box.id !== `comment-box-${index}`) {
                    box.style.display = 'none';
                }
            });
            commentBox.style.display = commentBox.style.display === 'block' ? 'none' : 'block';
        }

        function marcarCompletado(index) {
            const commentText = document.getElementById(`comment-text-${index}`).value.trim();
            
            const tareaCompletada = listaDeTareas[index];
            tareaCompletada.comentario = commentText || 'Sin comentario';
            tareaCompletada.fecha = new Date().toLocaleString();
            tareaCompletada.historialIndex = listaDeHistorial.length; 

            listaDeHistorial.push(tareaCompletada);
            
            listaDeTareas.splice(index, 1);
            
            actualizarTextareaConLista();
            renderizarTabla(); // Vuelve a renderizar la tabla, actualizando automáticamente el Radicado
            renderizarHistorial(false); 
            guardarDatos(); 

            alert(`Tarea ${tareaCompletada.id} archivada con éxito. Total en historial: ${listaDeHistorial.length}`);
        }

        function actualizarTextareaConLista() {
            const inputElement = document.getElementById('dataInput');
            let newText = '';
            
            listaDeTareas.forEach(tarea => {
                newText += `${tarea.estatus} ${tarea.tipo} ${tarea.id} ${tarea.codSuministro} ${tarea.valor} ${tarea.ahorro} ${tarea.eps} ${tarea.num}\n`;
            });
            
            inputElement.value = newText.trim();
        }
        
        // ----------------------------------------------------
        // --- Gestión de Historial (Archivado) ---
        // ----------------------------------------------------
        
        function renderizarHistorial(forceShow) {
            const historyOutput = document.getElementById('historyTableContainer');
            const historyContent = document.getElementById('historyOutput');
            
            if (listaDeHistorial.length === 0) {
                 historyOutput.innerHTML = '<p style="color: var(--secondary-color); text-align: center; padding: 10px; border: 1px dashed #ccc; border-radius: 5px;"><i class="fas fa-info-circle"></i> El historial está vacío.</p>';
                 return;
            }

            let tableHTML = `
                <div class="excel-table-container">
                    <table class="excel-table history-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-alt"></i> Fecha/Hora</th>
                                <th>ID Liquidación</th>
                                <th>EPS</th>
                                <th>Valor</th>
                                <th style="min-width: 350px;"><i class="fas fa-comment"></i> Comentario</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            listaDeHistorial.slice().reverse().forEach((tarea, indexReversed) => { 
                const originalIndex = listaDeHistorial.length - 1 - indexReversed;

                tableHTML += `
                    <tr>
                        <td>${tarea.fecha}</td>
                        <td class="cell-copy" onclick="copiarTextoTabla(this)">${tarea.id}</td>
                        <td>${tarea.eps}</td>
                        <td>${tarea.valor}</td>
                        <td id="comment-display-${originalIndex}">${tarea.comentario}</td>
                        <td>
                            <button class="edit-comment-button" onclick="iniciarEdicionComentario(${originalIndex}, this)"><i class="fas fa-edit"></i> Editar</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            historyOutput.innerHTML = tableHTML;
            
            if (forceShow) {
                historyContent.style.display = 'block';
                document.getElementById('historySection').querySelector('.section-header button').innerHTML = '<i class="fas fa-angle-up"></i> Ver Menos';
            }
        }

        function mostrarHistorial() {
            renderizarHistorial(true); 
        }

        function eliminarHistorialCompleto() {
            if (confirm("¿Estás seguro de que quieres ELIMINAR TODO el historial de tareas completadas? Esta acción es irreversible.")) {
                listaDeHistorial = [];
                renderizarHistorial(false);
                guardarDatos();
                alert("Historial eliminado con éxito.");
            }
        }
        
        function iniciarEdicionComentario(index, buttonElement) {
            const commentCell = document.getElementById(`comment-display-${index}`);
            const tarea = listaDeHistorial[index];
            const originalComment = tarea.comentario;
            
            commentCell.innerHTML = `
                <textarea id="edit-text-${index}" style="width: 100%; height: 60px; margin-bottom: 5px;">${originalComment}</textarea>
                <button class="save-comment-button" onclick="guardarComentarioEditado(${index})"><i class="fas fa-save"></i> Guardar</button>
                <button class="copy-button" style="background-color: #f0ad4e; margin-left: 5px;" onclick="cancelarEdicionComentario(${index}, '${originalComment}')"><i class="fas fa-times"></i> Cancelar</button>
            `;
            
            buttonElement.disabled = true;
            buttonElement.style.opacity = 0.5;
        }

        function guardarComentarioEditado(index) {
            const newComment = document.getElementById(`edit-text-${index}`).value.trim();
            
            listaDeHistorial[index].comentario = newComment;
            
            renderizarHistorial(true);
            guardarDatos();
        }

        function cancelarEdicionComentario(index, originalComment) {
            const commentCell = document.getElementById(`comment-display-${index}`);
            commentCell.innerHTML = originalComment;
            
            const editButton = commentCell.closest('tr').querySelector('.edit-comment-button');
            if (editButton) {
                editButton.disabled = false;
                editButton.style.opacity = 1;
            }
        }
        
        // ----------------------------------------------------
        // --- Utilidades de Interfaz ---
        // ----------------------------------------------------

        function toggleSection(contentId, buttonElement) {
            const content = document.getElementById(contentId);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                buttonElement.innerHTML = '<i class="fas fa-angle-up"></i> Ver Menos';
            } else {
                content.style.display = 'none';
                buttonElement.innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            }
        }


        // --- Base de Datos de Medicamentos y Buscador ---
        const medicamentos = { 
            "AMLODIPINO TABLETAS 5MG": "MD000150",
            "ACIDO ACETILSALICILICO 100 MG": "MD004978",
            "LOSARTAN TABLETA 50MG": "MD000161",
            "HIDROCLOROTIAZIDA TABLETA 25 MG": "MD000134",
            "METOPROLOL TABLETA 50 MG": "MD000145",
            "ATORVASTATINA TABLETA 40MG": "MD001258",
            "PRAZOSIN TABLETA 1 MG": "MD000132",
            "METFORMINA TABLETA 850 MG": "MD000032",
            "NAPROXENO TABLETA 250 MG": "MD000402",
            "PROPRANOLOL TABLETA 40 MG": "MD000148",
            "IBUPROFENO TABLETA 400 MG": "MD000300",
            "OMEPRAZOL CAPSULA 20 MG": "MD000200",
            "CLOPIDOGREL TABLETA 75 MG": "MD000555",
            "SIMVASTATINA TABLETA 20 MG": "MD000188"
        };
        
        function buscarMedicamento() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase().trim();
            const resultDiv = document.getElementById('searchResult');
            resultDiv.innerHTML = ''; 
            
            if (filter.length < 1) { 
                resultDiv.innerHTML = '<span style="color: var(--secondary-color);">Escriba al menos 1 letra para iniciar la búsqueda.</span>';
                return;
            }

            let found = false;
            let resultsHTML = '';
            
            for (const nombre in medicamentos) {
                if (nombre.toUpperCase().includes(filter)) {
                    const codigo = medicamentos[nombre];
                    const codigoId = `codigo-med-result-${codigo}`; 
                    
                    resultsHTML += `
                        <div class="info-item" style="border-bottom: none;">
                            <strong style="color: #000; min-width: auto; flex-basis: 50%;">${nombre}</strong>
                            <span id="${codigoId}" class="copy-target" style="flex-grow: 0; background-color: #ffe0e0;">${codigo}</span>
                            <button class="copy-button" onclick="copiarTexto('${codigoId}')" style="background-color: var(--danger-color);"><i class="fas fa-copy"></i> Copiar Código</button>
                        </div>
                    `;
                    found = true;
                }
            }

            if (found) {
                 resultDiv.innerHTML = resultsHTML;
            } else {
                resultDiv.innerHTML = '<span style="color: var(--secondary-color);">❌ No se encontró el medicamento.</span>';
            }
        }

        // --- Inicialización al cargar la página ---
        window.onload = function() {
            cargarDatos();
            
            // Si la lista está vacía al cargar, limpiar el radicado
            if (listaDeTareas.length === 0) {
                 document.getElementById('radicado').value = '';
            } else {
                 document.getElementById('radicado').value = listaDeTareas[0].id;
            }

            document.getElementById('historyOutput').style.display = 'none';
            document.getElementById('accesos-credenciales-content').style.display = 'none';
            
            document.getElementById('historySection').querySelector('.section-header button').innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            document.getElementById('accesos-credenciales-section').querySelector('.section-header button').innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
        };
    </script>
</body>
</html>
