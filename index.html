<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas de Reasignación</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- VARIABLES DE ESTILO --- */
        :root {
            --primary-color: #0077c2; /* Azul Corporativo */
            --secondary-color: #555e6a; /* Gris Oscuro */
            --background-light: #f4f6f9; /* Fondo muy claro */
            --card-background: #ffffff;
            --border-color: #e0e0e0;
            --success-color: #1a995e; /* Verde */
            --danger-color: #d9534f; /* Rojo */
            --excel-header-color: #e6f7ff; /* Azul claro para encabezados de tabla */
            --excel-border-color: #c9c9c9;
            --complete-button-color: #ff9800; /* Naranja para Archivar */
            --history-color: #00bcd4; /* Cian para Historial */
            --font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            --toggle-color: #6c757d;
        }

        /* --- ESTILOS GENERALES Y LAYOUT --- */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding-top: 60px; /* Espacio para la Navbar fija */
            padding-bottom: 20px;
            background-color: var(--background-light);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 30px;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        /* Títulos */
        h1 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-weight: 300;
            font-size: 2.2em;
        }

        /* Secciones */
        .section {
            margin-bottom: 35px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: #ffffff;
            transition: box-shadow 0.3s;
        }
        
        .section:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }

        /* --- NAVBAR FIJA PROFESIONAL --- */
        #main-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 55px;
            overflow-x: auto; /* Permite scroll horizontal en móvil si hay muchos botones */
            -webkit-overflow-scrolling: touch;
        }

        #main-navbar .nav-links {
            display: flex;
            gap: 5px;
            padding: 0 10px;
            align-items: center;
        }
        
        .nav-button {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            border-radius: 4px;
            transition: background-color 0.2s, transform 0.1s;
            white-space: nowrap; /* Evita que el texto se rompa */
        }
        
        .nav-button:hover {
            background-color: #005f9c;
        }
        
        /* Ajuste de scroll-margin-top para anclajes */
        .section {
            scroll-margin-top: 80px; /* Deja espacio debajo de la navbar */
        }

        /* --- ITEMS DE COPIA Y BOTONES (Se mantienen igual) --- */
        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 15px;
            flex-wrap: nowrap; 
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
        }

        .info-item strong {
            min-width: 150px; 
            flex-shrink: 0; 
            font-weight: 600;
            color: #333;
        }

        .copy-target, .editable-input {
            background-color: #f7f7f7;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #dcdcdc;
            flex-grow: 1; 
            min-width: 150px;
            font-family: 'Consolas', monospace;
            overflow-x: auto;
            white-space: nowrap;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        
        .editable-input {
            width: auto;
            color: var(--danger-color);
            font-weight: bold;
            border: 1px solid var(--danger-color);
        }

        .copy-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 18px;
            text-align: center;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, transform 0.1s;
            min-width: 100px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .copy-button:hover {
            background-color: #005f9c;
            transform: translateY(-1px);
        }
        
        /* --- ESTILOS DE TABLAS Y GESTIÓN DE TAREAS (Se mantienen igual) --- */
        #dataInput {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: 'Consolas', monospace;
            resize: vertical;
            background-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #generateButton {
            background-color: var(--success-color);
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }
        
        #generateButton:hover {
            background-color: #15734e;
        }

        #showHistoryButton {
            background-color: var(--history-color);
            flex-grow: 1;
        }
        
        #showHistoryButton:hover {
             background-color: #0097a7;
        }
        
        .excel-table-container {
             margin-top: 20px;
             overflow-x: auto; 
             -webkit-overflow-scrolling: touch;
        }
        
        .excel-table {
            width: 100%;
            min-width: 1000px;
            border-collapse: collapse;
            font-size: 0.85em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .excel-table th, .excel-table td {
            border: 1px solid var(--excel-border-color);
            padding: 10px 8px;
            text-align: left;
            white-space: nowrap; 
        }

        .excel-table th {
            background-color: var(--excel-header-color);
            font-weight: 600;
            color: var(--secondary-color);
            text-transform: uppercase;
        }
        
        .excel-table tr:nth-child(even) {
            background-color: #fcfcfc;
        }

        .excel-table .cell-copy {
            cursor: copy;
            font-weight: bold;
            color: var(--primary-color);
            background-color: #e6f7ff; 
            transition: background-color 0.1s;
        }
        
        .excel-table .cell-copy:hover {
            background-color: #cceeff;
        }
        
        /* GESTIÓN DE COMENTARIOS (ARCHIVAR) */
        .complete-row-button {
            background-color: var(--complete-button-color);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
        }
        
        .complete-row-button:hover {
             background-color: #e68a00;
        }

        .comment-container {
            padding: 15px;
            margin-top: 10px;
            border: 2px solid var(--complete-button-color);
            border-radius: 8px;
            background-color: #fff8e1;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .comment-counter {
            background-color: var(--danger-color);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .comment-container textarea {
            min-height: 80px;
            padding: 10px;
            border: 1px solid #f9d8a3;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .save-comment-button {
            background-color: var(--success-color);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        /* HISTORIAL STYLING */
        .history-table .action-cell {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 5px 8px;
        }
        
        .history-table .action-cell button {
             font-size: 0.8em;
             padding: 5px;
        }
        
        .copy-history-button {
            background-color: #3f51b5; 
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .copy-history-button:hover {
            background-color: #303f9f;
        }


        /* --- NOTIFICACIÓN DE AUTO-GUARDADO (Se mantiene igual) --- */
        #saveNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
            font-size: 0.9em;
        }
        
        #saveNotification.show {
            opacity: 1;
        }


        /* --- RESPONSIVE MOBILE (Máximo 768px de ancho) --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-top: 55px; /* Ajustar padding para la Navbar en móvil */
            }
            .container {
                padding: 15px;
                box-shadow: none; 
            }
            
            /* Navbar se asegura de centrarse y permitir scroll horizontal */
            #main-navbar {
                 justify-content: flex-start; 
            }
            
            #main-navbar .nav-links {
                padding: 0 5px;
            }
            
            .nav-button {
                font-size: 0.7em;
                padding: 5px 8px;
            }

            /* El scroll-margin-top se ajusta */
            .section {
                 scroll-margin-top: 70px; 
            }

            /* Los info-item se apilan verticalmente */
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                border-bottom: 1px solid var(--border-color); 
                padding-bottom: 10px;
            }
            
            .info-item strong {
                min-width: 100%;
            }
            
            .info-item .copy-target, 
            .info-item .editable-input,
            .info-item .copy-button {
                flex-grow: 1;
                width: 100%;
                min-width: 100%; 
            }

            /* Botones principales de la lista (Construir y Historial) se apilan */
            .control-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            #generateButton, #showHistoryButton {
                width: 100%;
                margin: 0 !important;
            }
            
            /* En el historial, los botones de acción se vuelven de ancho completo */
            .history-table .action-cell {
                 flex-direction: row;
                 flex-wrap: wrap;
            }
            
            .history-table .action-cell button {
                 flex-grow: 1;
                 min-width: 100px;
            }
        }
    </style>
</head>
<body>

    <div id="main-navbar">
        <div class="nav-links">
            <a class="nav-button" href="#designacion-tarea-section"><i class="fas fa-user-tag"></i> Designación</a>
            <a class="nav-button" href="#tarea-activa-section"><i class="fas fa-clipboard-list"></i> Tarea Activa</a>
            <a class="nav-button" href="#tareas-pendientes-section"><i class="fas fa-list-alt"></i> Tareas Pendientes</a>
            <a class="nav-button" href="#historySection"><i class="fas fa-archive"></i> Historial</a>
            <a class="nav-button" href="#accesos-credenciales-section"><i class="fas fa-key"></i> Accesos</a>
            <a class="nav-button" href="#buscador-medicamentos-section"><i class="fas fa-prescription-bottle-alt"></i> Buscador</a>
        </div>
    </div>

    <div class="container">
        <h1><i class="fas fa-tasks"></i> Gestor de Tareas de Reasignación</h1>

        <div id="saveNotification">
            <i class="fas fa-save"></i> Datos guardados automáticamente.
        </div>

        <div class="section" id="designacion-tarea-section">
             <div class="section-header">
                <h2><i class="fas fa-user-tag"></i> Designación de Tarea</h2>
            </div>
            <div class="section-content">
                <div class="info-item">
                    <strong>ACCIÓN:</strong>
                    <span id="accion" class="copy-target" style="color: var(--danger-color);">Reasignar</span>
                    <button class="copy-button" onclick="copiarTexto('accion')" style="background-color: var(--danger-color);"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                 <div class="info-item">
                    <strong>NOMBRE DE DESTINO:</strong>
                    <span id="reasignar" class="copy-target">BRAYAN CORONADO CUELLAR</span>
                    <button class="copy-button" onclick="copiarTexto('reasignar')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
            </div>
        </div>


        <div class="section" id="tarea-activa-section">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-list"></i> Tarea Activa (Datos Principales)</h2>
            </div>
             <div class="section-content">
                <p style="color: var(--secondary-color); font-size: 0.9em;">**NOTA IMPORTANTE:** El **Radicado / ID Actual** se actualiza automáticamente con el **Cód. Suministro** de la primera tarea pendiente.</p>
                
                <div class="info-item">
                    <strong>RADICADO / ID ACTUAL:</strong>
                    <input type="text" id="radicado" class="copy-target editable-input" value="">
                    <button class="copy-button" onclick="copiarTexto('radicado')"><i class="fas fa-copy"></i> Copiar Radicado</button>
                </div>
                <div class="info-item">
                    <strong>INICIO MOVILIDAD (MV):</strong>
                    <span id="mv" class="copy-target">Colombia2033*</span>
                    <button class="copy-button" onclick="copiarTexto('mv')"><i class="fas fa-copy"></i> Copiar Clave MV</button>
                </div>
                <div class="info-item">
                    <strong>CÓDIGO SUMINISTRO:</strong>
                    <span id="suministro" class="copy-target">91010101</span>
                    <button class="copy-button" onclick="copiarTexto('suministro')"><i class="fas fa-copy"></i> Copiar Código</button>
                </div>
             </div>
        </div>
        
        
        <div class="section" id="tareas-pendientes-section">
            <div class="section-header">
                <h2><i class="fas fa-list-alt"></i> Tareas Pendientes y Gestión</h2>
                <button onclick="toggleSection('tareas-pendientes-content', this)"><i class="fas fa-angle-up"></i> Ver Menos</button>
            </div>
            
            <div class="section-content" id="tareas-pendientes-content">
                <p style="color: var(--secondary-color);">**Instrucción:** Pega el listado de liquidaciones aquí y haz clic en Construir Lista.</p>
                
                <textarea id="dataInput" placeholder="Pega aquí los datos de Excel (cada liquidación en una línea nueva)...
Ejemplo:
Asignado Liquidacion 242385169 900190045 $ 28.700 $ 0 Nueva EPS 1
Por Vencer 251789321 811021843 $ 39.500 $ 0 Nueva EPS 1"></textarea>
                
                <div class="control-buttons">
                    <button id="generateButton" onclick="generarTablaPersonalizada()"><i class="fas fa-cogs"></i> Construir Lista de Tareas</button>
                    <button id="showHistoryButton" class="copy-button" onclick="mostrarHistorial()"><i class="fas fa-history"></i> Ver Historial</button>
                </div>

                <div id="dynamicTableOutput">
                    <p style="text-align: center; color: var(--secondary-color); padding: 10px; border: 1px dashed #ccc; border-radius: 5px;">*La lista de tareas pendientes aparecerá aquí.*</p>
                </div>
                
                <div id="copyAllIdsContainer" class="info-item" style="display:none; margin-top: 20px; border: none; padding-bottom: 0;">
                    <span id="generated-ids-copia-manual" class="copy-target" style="display: none;"></span>
                    <button id="copyAllIdsButton" class="copy-button" onclick="copiarTexto('generated-ids-copia-manual')" style="background-color: var(--success-color); flex-grow: 1;"><i class="fas fa-paste"></i> Copiar TODOS los IDs restantes</button>
                </div>
            </div>
        </div>

        
        <div class="section" id="historySection">
            <div class="section-header">
                <h2><i class="fas fa-archive"></i> Historial de Tareas Completadas</h2>
                <button onclick="toggleSection('historyOutput', this)"><i class="fas fa-angle-down"></i> Ver Más</button>
            </div>
            <div class="section-content" id="historyOutput" style="display:none;">
                <div class="history-actions">
                    <button id="deleteAllHistoryButton" onclick="eliminarHistorialCompleto()"><i class="fas fa-trash-alt"></i> Eliminar Historial Completo</button>
                    <p style="color: var(--secondary-color);">*El historial se guarda automáticamente en tu navegador.</p>
                </div>
                 <div id="historyTableContainer">
                    <p style="color: var(--secondary-color); text-align: center; padding: 10px; border: 1px dashed #ccc; border-radius: 5px;">No hay tareas archivadas.</p>
                 </div>
            </div>
        </div>
        

        <div class="section" id="accesos-credenciales-section">
            <div class="section-header">
                <h2><i class="fas fa-key"></i> Accesos y Credenciales</h2>
                <button onclick="toggleSection('accesos-credenciales-content', this)"><i class="fas fa-angle-down"></i> Ver Más</button>
            </div>
            
            <div class="section-content" id="accesos-credenciales-content" style="display:none;">
                
                <h3><i class="fas fa-user-lock"></i> ONBASE</h3>
                <div class="info-item">
                    <strong>URL:</strong>
                    <a id="onbaseURL" class="copy-target" href="https://ecm.nuevaeps.com.co/OnBase/Login.aspx" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">https://ecm.nuevaeps.com.co/OnBase/Login.aspx</a>
                    <button class="copy-button" onclick="copiarTexto('onbaseURL')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>USUARIO:</strong>
                    <span id="onbaseUser" class="copy-target">mgamas</span>
                    <button class="copy-button" onclick="copiarTexto('onbaseUser')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>CLAVE:</strong>
                    <span id="onbasePass" class="copy-target">Colombia2029*</span>
                    <button class="copy-button" onclick="copiarTexto('onbasePass')"><i class="fas fa-copy"></i> Copiar</button>
                </div>

                <br>
                
                <h3><i class="fas fa-desktop"></i> AUP</h3>
                <div class="info-item">
                    <strong>URL:</strong>
                    <a id="aupURL" class="copy-target" href="https://aup.procesosyservicios.net.co/Login.aspx" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">https://aup.procesosyservicios.net.co/Login.aspx</a>
                    <button class="copy-button" onclick="copiarTexto('aupURL')"><i class="fas fa-copy"></i> Copiar URL</button>
                </div>
                
                <br>

                <h3><i class="fas fa-hospital"></i> NUEVA EPS</h3>
                <div class="info-item">
                    <strong>USUARIO:</strong>
                    <span id="nuevaepsUser" class="copy-target">Bcoronadoccmp</span>
                    <button class="copy-button" onclick="copiarTexto('nuevaepsUser')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
                <div class="info-item">
                    <strong>CLAVE:</strong>
                    <span id="nuevaepsPass" class="copy-target">Pys2034*</span>
                    <button class="copy-button" onclick="copiarTexto('nuevaepsPass')"><i class="fas fa-copy"></i> Copiar</button>
                </div>
            </div>
        </div>

        <div class="section search-container" id="buscador-medicamentos-section">
             <div class="section-header">
                <h2><i class="fas fa-prescription-bottle-alt"></i> Buscador de Códigos de Medicamentos</h2>
            </div>
            <div class="section-content">
                <p style="color: var(--secondary-color);">Escribe el nombre del medicamento para encontrar su código rápidamente. **Ahora se activa con solo 1 letra.**</p>
                <input type="text" id="searchInput" placeholder="Ej: AMOXICILINA, LISINOPRIL..." onkeyup="buscarMedicamento()" class="copy-target">
                <div id="searchResult"></div>
            </div>
        </div>

    </div>

    <script>
        // --- VARIABLES GLOBALES Y ALMACENAMIENTO ---
        let listaDeTareas = [];
        let listaDeHistorial = [];

        // Colores y utilidades
        const var_success_color = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
        const var_primary_color = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
        const var_danger_color = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim();
        const var_toggle_color = getComputedStyle(document.documentElement).getPropertyValue('--toggle-color').trim();

        // ----------------------------------------------------
        // --- GESTIÓN DE LOCALSTORAGE (AUTO-GUARDADO) ---
        // ----------------------------------------------------

        function guardarDatos() {
            try {
                localStorage.setItem('reasignacion_tareas', JSON.stringify(listaDeTareas));
                localStorage.setItem('reasignacion_historial', JSON.stringify(listaDeHistorial));
                mostrarNotificacionGuardado();
            } catch (e) {
                console.error("Error al guardar en LocalStorage:", e);
            }
        }

        function cargarDatos() {
            try {
                const tareasGuardadas = localStorage.getItem('reasignacion_tareas');
                const historialGuardado = localStorage.getItem('reasignacion_historial');

                if (tareasGuardadas) {
                    listaDeTareas = JSON.parse(tareasGuardadas);
                    actualizarTextareaConLista();
                }
                if (historialGuardado) {
                    listaDeHistorial = JSON.parse(historialGuardado);
                    renderizarHistorial(); 
                }
            } catch (e) {
                console.error("Error al cargar datos de LocalStorage:", e);
            }
        }

        function mostrarNotificacionGuardado() {
            const notif = document.getElementById('saveNotification');
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 2000);
        }

        // ----------------------------------------------------
        // --- Funciones de Copia y Notificación ---
        // ----------------------------------------------------

        function copiarTexto(elementId) {
             const targetElement = document.getElementById(elementId);
             let textToCopy;
             if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA') {
                 textToCopy = targetElement.value;
             } else {
                 textToCopy = targetElement.textContent || targetElement.innerText;
             }
             copiarYNotificar(targetElement, textToCopy);
        }
        function copiarTextoTabla(cellElement) {
             const textToCopy = cellElement.textContent || cellElement.innerText;
             copiarYNotificar(cellElement, textToCopy, true);
        }
        
        // Versión especial para copiar el código o comentario del historial
        function copiarHistorialDato(index, dataType) {
            const tarea = listaDeHistorial[index];
            let textToCopy;
            let targetElementId;
            
            if (dataType === 'codSuministro') {
                textToCopy = tarea.codSuministro;
                targetElementId = `copy-suministro-btn-${index}`;
            } else if (dataType === 'comentario') {
                textToCopy = tarea.comentario;
                targetElementId = `copy-comment-btn-${index}`;
            } else {
                return;
            }
            
            const targetElement = document.getElementById(targetElementId);
            copiarYNotificar(targetElement, textToCopy);
        }


        function copiarYNotificar(targetElement, textToCopy, isTableCell = false) {
             if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        mostrarNotificacion(targetElement, '✅ Copiado!', isTableCell);
                    })
                    .catch(err => {
                        copiarTextoFallback(targetElement, textToCopy, isTableCell);
                    });
            } else {
                copiarTextoFallback(targetElement, textToCopy, isTableCell);
            }
        }
        
        function copiarTextoFallback(targetElement, textToCopy, isTableCell) {
             const textArea = document.createElement("textarea");
             textArea.value = textToCopy;
             textArea.style.position = "fixed"; 
             textArea.style.opacity = "0"; 
             document.body.appendChild(textArea);
             textArea.focus();
             textArea.select();
             try {
                 document.execCommand('copy');
                 mostrarNotificacion(targetElement, '✅ Copiado!', isTableCell);
             } catch (err) {
                 alert('Error al copiar. Por favor, copie manualmente: ' + textToCopy);
             }
             document.body.removeChild(textArea);
        }

        function mostrarNotificacion(targetElement, message, isTableCell) {
            let button = targetElement;
            let originalText = button.textContent;
            let originalBg = getComputedStyle(button).backgroundColor;
            let restoreColor = originalBg; 

            // Si es un botón del historial, necesitamos el color original correcto
            if (button.classList.contains('copy-history-button') || button.classList.contains('edit-comment-button')) {
                 if (button.id.includes('copy-suministro-btn') || button.id.includes('copy-comment-btn')) {
                     restoreColor = '#3f51b5'; // Color Indigo para restauración
                 } else if (button.classList.contains('edit-comment-button')) {
                     restoreColor = var_history_color; // Color cian para edición
                 }
            } else if (button.classList.contains('copy-button') && button.id.includes('copyAllIdsButton')) {
                 restoreColor = var_success_color;
            } else if (!isTableCell) {
                // Si no es celda ni botón de historial, busca el botón asociado si es un target.
                button = targetElement.nextElementSibling;
                if (!button || !button.classList.contains('copy-button')) {
                    if (targetElement.id.startsWith('codigo-med-result')) {
                       button = targetElement.closest('.info-item').querySelector('.copy-button');
                    } else if (targetElement.id === 'generated-ids-copia-manual') {
                       button = document.getElementById('copyAllIdsButton');
                    } else {
                        return;
                    }
                }
                originalText = button.textContent;
                // Ajustar el color de restauración para los botones principales
                if (targetElement.id === 'accion') {
                    restoreColor = var_danger_color;
                } else {
                    restoreColor = var_primary_color; 
                }
            }


            button.textContent = message;
            button.style.backgroundColor = var_success_color;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = restoreColor;
            }, 1500);
        }


        // ----------------------------------------------------
        // --- Generador de Tabla y Gestión de Tareas ---
        // ----------------------------------------------------

        function generarTablaPersonalizada() {
            const inputElement = document.getElementById('dataInput');
            const rawText = inputElement.value.trim();
            listaDeTareas = [];

            if (!rawText) {
                renderizarTabla();
                return;
            }

            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            lines.forEach(line => {
                // EXPRESION REGULAR: Separa por uno o más espacios en blanco.
                const cells = line.trim().split(/\s{1,}/);
                
                if (cells.length >= 8) {
                    listaDeTareas.push({
                        estatus: cells[0],
                        tipo: cells[1],
                        id: cells[2], // ID LIQUIDACIÓN (POSICIÓN 3)
                        codSuministro: cells[3], // CÓD. SUMINISTRO (POSICIÓN 4) <-- ¡ESTE ES EL QUE BUSCAMOS!
                        valor: cells[4],
                        ahorro: cells[5],
                        eps: cells[6],
                        num: cells[7]
                    });
                }
            });

            renderizarTabla();
            guardarDatos(); 
        }

        function renderizarTabla() {
            const outputDiv = document.getElementById('dynamicTableOutput');
            const radicadoInput = document.getElementById('radicado');
            const copyAllIdsContainer = document.getElementById('copyAllIdsContainer');
            const copyAllIdsSpan = document.getElementById('generated-ids-copia-manual');
            
            outputDiv.innerHTML = '';
            copyAllIdsContainer.style.display = 'none';
            radicadoInput.value = ''; 

            if (listaDeTareas.length === 0) {
                outputDiv.innerHTML = '<p style="text-align: center; color: var(--secondary-color); padding: 10px; border: 1px dashed #ccc; border-radius: 5px;"><i class="fas fa-check-circle"></i> Todas las tareas han sido completadas o no hay datos cargados.</p>';
                return;
            }

            if (listaDeTareas.length > 0) {
                radicadoInput.value = listaDeTareas[0].codSuministro; 
            }

            let tableHTML = `
                <div class="excel-table-container">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th>Estatus</th>
                                <th>Tipo</th>
                                <th>ID Liquidación</th>
                                <th>Cód. Suministro</th>
                                <th>Valor</th>
                                <th>Ahorro</th>
                                <th>EPS</th>
                                <th>Num</th>
                                <th style="min-width: 150px;">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let allIds = [];
            
            listaDeTareas.forEach((tarea, index) => {
                allIds.push(tarea.id); 
                
                tableHTML += `
                    <tr id="tarea-row-${index}">
                        <td>${tarea.estatus}</td>
                        <td>${tarea.tipo}</td>
                        <td class="cell-copy" onclick="copiarTextoTabla(this)">${tarea.id}</td>
                        <td class="cell-copy" onclick="copiarTextoTabla(this)">${tarea.codSuministro}</td>
                        <td>${tarea.valor}</td>
                        <td>${tarea.ahorro}</td>
                        <td>${tarea.eps}</td>
                        <td>${tarea.num}</td>
                        <td style="text-align: center;">
                            <button class="complete-row-button" onclick="mostrarComentario(${index})"><i class="fas fa-archive"></i> Archivar Tarea</button>
                            <div id="comment-box-${index}" class="comment-container">
                                <span class="comment-counter">Tareas: 1</span>
                                <textarea id="comment-text-${index}" placeholder="Escribe tu comentario..."></textarea>
                                <button class="save-comment-button" onclick="marcarCompletado(${index})"><i class="fas fa-save"></i> Guardar Comentario</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            outputDiv.innerHTML = tableHTML;
            
            copyAllIdsSpan.textContent = allIds.join(', ');
            copyAllIdsContainer.style.display = 'flex';
        }

        function mostrarComentario(index) {
            const commentBox = document.getElementById(`comment-box-${index}`);
            document.querySelectorAll('.comment-container').forEach(box => {
                if (box.id !== `comment-box-${index}`) {
                    box.style.display = 'none';
                }
            });
            commentBox.style.display = commentBox.style.display === 'block' ? 'none' : 'block';
        }

        // ----------------------------------------------------
        // --- FUNCIÓN CRÍTICA DE ARCHIVADO ---
        // ----------------------------------------------------

        function marcarCompletado(index) {
            
            // Forzamos que solo se pueda archivar la primera tarea (index 0) 
            if (index !== 0) {
                 alert("¡Atención! Solo se puede archivar la primera tarea de la lista.");
                 return;
            }

            const tareaCompletada = listaDeTareas[index];

            if (!tareaCompletada) {
                alert("Error crítico: No se encontró la tarea en el índice especificado. Intente recargar.");
                return;
            }
            
            try {
                // 1. Obtener comentario
                const commentTextElement = document.getElementById(`comment-text-${index}`);
                const commentText = commentTextElement ? commentTextElement.value.trim() : 'Sin comentario';
                
                // 2. Mover la tarea al historial (Guardado)
                tareaCompletada.comentario = commentText;
                tareaCompletada.fecha = new Date().toLocaleString();
                
                tareaCompletada.historialIndex = listaDeHistorial.length; 
                listaDeHistorial.push(tareaCompletada);
                
                // 3. Eliminación visual INMEDIATA para feedback
                const rowToRemove = document.getElementById(`tarea-row-${index}`);
                if (rowToRemove) {
                    rowToRemove.style.transition = 'all 0.4s ease-in-out';
                    rowToRemove.style.opacity = '0';
                }

                // 4. Eliminar la tarea de la lista pendiente (index 0)
                listaDeTareas.splice(0, 1); 
                
                // 5. Actualizar el textarea con la lista restante
                actualizarTextareaConLista();
                
                setTimeout(() => {
                    // 6. Volver a dibujar la tabla
                    renderizarTabla(); 
                    // 7. Renderizar el historial 
                    renderizarHistorial(); 
                    // 8. Guardar en LocalStorage
                    guardarDatos(); 

                    alert(`Tarea ${tareaCompletada.id} archivada con éxito.
                    La siguiente tarea (${listaDeTareas.length > 0 ? listaDeTareas[0].codSuministro : 'N/A'}) se ha cargado automáticamente en el Radicado.`);
                }, 400); 

            } catch (e) {
                alert("¡ERROR CRÍTICO! Fallo durante el proceso de archivado. Mensaje de Error: " + e.message);
                console.error("Fallo durante el proceso de archivado:", e);
            }
        }
        // ----------------------------------------------------


        function actualizarTextareaConLista() {
            const inputElement = document.getElementById('dataInput');
            let newText = '';
            
            listaDeTareas.forEach(tarea => {
                newText += `${tarea.estatus} ${tarea.tipo} ${tarea.id} ${tarea.codSuministro} ${tarea.valor} ${tarea.ahorro} ${tarea.eps} ${tarea.num}\n`;
            });
            
            inputElement.value = newText.trim();
        }
        
        // ----------------------------------------------------
        // --- Gestión de Historial (Archivado) ---
        // ----------------------------------------------------
        
        function renderizarHistorial() {
            const historyOutput = document.getElementById('historyTableContainer');
            
            if (listaDeHistorial.length === 0) {
                 historyOutput.innerHTML = '<p style="color: var(--secondary-color); text-align: center; padding: 10px; border: 1px dashed #ccc; border-radius: 5px;"><i class="fas fa-info-circle"></i> El historial está vacío.</p>';
                 return;
            }

            let tableHTML = `
                <div class="excel-table-container">
                    <table class="excel-table history-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-alt"></i> Fecha/Hora</th>
                                <th>ID Liquidación</th>
                                <th>EPS</th>
                                <th>Valor</th>
                                <th>Cód. Suministro</th>
                                <th style="min-width: 250px;"><i class="fas fa-comment"></i> Comentario</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Mostrar del más reciente al más antiguo
            listaDeHistorial.slice().reverse().forEach((tarea, indexReversed) => { 
                const originalIndex = listaDeHistorial.length - 1 - indexReversed;

                tableHTML += `
                    <tr>
                        <td>${tarea.fecha}</td>
                        <td class="cell-copy" onclick="copiarTextoTabla(this)">${tarea.id}</td>
                        <td>${tarea.eps}</td>
                        <td>${tarea.valor}</td>
                        <td id="cod-suministro-display-${originalIndex}" class="cell-copy">${tarea.codSuministro}</td>
                        <td id="comment-display-${originalIndex}" style="white-space: normal;">${tarea.comentario}</td>
                        <td class="action-cell">
                            <button id="copy-suministro-btn-${originalIndex}" class="copy-history-button" onclick="copiarHistorialDato(${originalIndex}, 'codSuministro')"><i class="fas fa-copy"></i> Cód. Suministro</button>
                            <button id="copy-comment-btn-${originalIndex}" class="copy-history-button" onclick="copiarHistorialDato(${originalIndex}, 'comentario')"><i class="fas fa-copy"></i> Comentario</button>
                            <button class="edit-comment-button" style="background-color: var(--history-color);" onclick="iniciarEdicionComentario(${originalIndex}, this)"><i class="fas fa-edit"></i> Editar</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            historyOutput.innerHTML = tableHTML;
        }

        function mostrarHistorial() {
            const content = document.getElementById('historyOutput');
            const headerButton = document.getElementById('historySection').querySelector('.section-header button');

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                headerButton.innerHTML = '<i class="fas fa-angle-up"></i> Ver Menos';
                renderizarHistorial(); 
            } else {
                content.style.display = 'none';
                headerButton.innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            }
        }


        function eliminarHistorialCompleto() {
            if (confirm("¿Estás seguro de que quieres ELIMINAR TODO el historial de tareas completadas? Esta acción es irreversible.")) {
                listaDeHistorial = [];
                renderizarHistorial();
                guardarDatos();
                alert("Historial eliminado con éxito.");
            }
        }
        
        function iniciarEdicionComentario(index, buttonElement) {
            const commentCell = document.getElementById(`comment-display-${index}`);
            const tarea = listaDeHistorial[index];
            const originalComment = tarea.comentario;
            
            commentCell.innerHTML = `
                <textarea id="edit-text-${index}" style="width: 100%; height: 60px; margin-bottom: 5px; box-sizing: border-box;">${originalComment}</textarea>
                <button class="save-comment-button" onclick="guardarComentarioEditado(${index})"><i class="fas fa-save"></i> Guardar</button>
                <button class="copy-button" style="background-color: #f0ad4e; margin-left: 5px;" onclick="cancelarEdicionComentario(${index}, \`${originalComment.replace(/`/g, '\\`')}\`)"><i class="fas fa-times"></i> Cancelar</button>
            `;
            
            // Ocultar la celda de acciones mientras se edita
            const actionCell = buttonElement.closest('td');
            actionCell.style.display = 'none'; 
        }

        function guardarComentarioEditado(index) {
            const newComment = document.getElementById(`edit-text-${index}`).value.trim();
            
            listaDeHistorial[index].comentario = newComment;
            
            // Mostrar la celda de acciones
            const actionCell = document.getElementById(`comment-display-${index}`).closest('tr').querySelector('.action-cell');
            if (actionCell) {
                 actionCell.style.display = 'flex';
            }

            renderizarHistorial();
            guardarDatos();
        }

        function cancelarEdicionComentario(index, originalComment) {
            const commentCell = document.getElementById(`comment-display-${index}`);
            commentCell.innerHTML = originalComment;
            
            // Mostrar la celda de acciones
            const actionCell = commentCell.closest('tr').querySelector('.action-cell');
            if (actionCell) {
                actionCell.style.display = 'flex';
            }
            
            // Forzar renderizado para restaurar el HTML original
            renderizarHistorial();
        }
        
        // ----------------------------------------------------
        // --- Utilidades de Interfaz ---
        // ----------------------------------------------------

        function toggleSection(contentId, buttonElement) {
            const content = document.getElementById(contentId);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                buttonElement.innerHTML = '<i class="fas fa-angle-up"></i> Ver Menos';
            } else {
                content.style.display = 'none';
                buttonElement.innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            }
        }


        // --- Base de Datos de Medicamentos y Buscador ---
        const medicamentos = { 
            "AMLODIPINO TABLETAS 5MG": "MD000150",
            "ACIDO ACETILSALICILICO 100 MG": "MD004978",
            "LOSARTAN TABLETA 50MG": "MD000161",
            "HIDROCLOROTIAZIDA TABLETA 25 MG": "MD000134",
            "METOPROLOL TABLETA 50 MG": "MD000145",
            "ATORVASTATINA TABLETA 40MG": "MD001258",
            "PRAZOSIN TABLETA 1 MG": "MD000132",
            "METFORMINA TABLETA 850 MG": "MD000032",
            "NAPROXENO TABLETA 250 MG": "MD000402",
            "PROPRANOLOL TABLETA 40 MG": "MD000148",
            "IBUPROFENO TABLETA 400 MG": "MD000300",
            "OMEPRAZOL CAPSULA 20 MG": "MD000200",
            "CLOPIDOGREL TABLETA 75 MG": "MD000555",
            "SIMVASTATINA TABLETA 20 MG": "MD000188"
        };
        
        function buscarMedicamento() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase().trim();
            const resultDiv = document.getElementById('searchResult');
            resultDiv.innerHTML = ''; 
            
            if (filter.length < 1) { 
                resultDiv.innerHTML = '<span style="color: var(--secondary-color);">Escriba al menos 1 letra para iniciar la búsqueda.</span>';
                return;
            }

            let found = false;
            let resultsHTML = '';
            
            for (const nombre in medicamentos) {
                if (nombre.toUpperCase().includes(filter)) {
                    const codigo = medicamentos[nombre];
                    const codigoId = `codigo-med-result-${codigo}`; 
                    
                    resultsHTML += `
                        <div class="info-item" style="border-bottom: none;">
                            <strong style="color: #000; min-width: auto; flex-basis: 50%;">${nombre}</strong>
                            <span id="${codigoId}" class="copy-target" style="flex-grow: 0; background-color: #ffe0e0;">${codigo}</span>
                            <button class="copy-button" onclick="copiarTexto('${codigoId}')" style="background-color: var(--danger-color);"><i class="fas fa-copy"></i> Copiar Código</button>
                        </div>
                    `;
                    found = true;
                }
            }

            if (found) {
                 resultDiv.innerHTML = resultsHTML;
            } else {
                resultDiv.innerHTML = '<span style="color: var(--secondary-color);">❌ No se encontró el medicamento.</span>';
            }
        }

        // --- Inicialización al cargar la página ---
        const var_history_color = getComputedStyle(document.documentElement).getPropertyValue('--history-color').trim();

        window.onload = function() {
            cargarDatos();
            
            if (listaDeTareas.length === 0) {
                 document.getElementById('radicado').value = '';
            } else {
                 renderizarTabla();
            }

            // Asegurar que las secciones estén en su estado inicial (colapsado)
            document.getElementById('historyOutput').style.display = 'none';
            document.getElementById('accesos-credenciales-content').style.display = 'none';
            
            // Establecer el texto de los botones de Ver Más/Menos
            document.getElementById('historySection').querySelector('.section-header button').innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
            document.getElementById('accesos-credenciales-section').querySelector('.section-header button').innerHTML = '<i class="fas fa-angle-down"></i> Ver Más';
        };
    </script>
</body>
</html>
